<!DOCTYPE html>
<html lang="en">
  

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,minimum-scale=1">

  <title>TF-data</title>
  <meta name="description" content="Chapter 13 – Loading and Preprocessing Data with TensorFlow">

  <link rel="canonical" href="http://localhost:4000//notebooks/24-tensorflow/13_loading_and_preprocessing_data.html">
  <link rel="alternate" type="application/rss+xml" title="MGMT6560 Fall 19" href="http://localhost:4000//feed.xml">

  <meta property="og:url"         content="http://localhost:4000//notebooks/24-tensorflow/13_loading_and_preprocessing_data.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="TF-data" />
<meta property="og:description" content="Chapter 13 – Loading and Preprocessing Data with TensorFlow" />
<meta property="og:image"       content="" />


  <script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "NewsArticle",
  "mainEntityOfPage":
    "http://localhost:4000//notebooks/24-tensorflow/13_loading_and_preprocessing_data.html",
  "headline":
    "TF-data",
  "datePublished":
    "2019-11-30T22:01:55-05:00",
  "dateModified":
    "2019-11-30T22:01:55-05:00",
  "description":
    "Chapter 13 – Loading and Preprocessing Data with TensorFlow",
  "author": {
    "@type": "Person",
    "name": "Jason Kuruzovich"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Data 100 at UC Berkeley",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:4000/",
      "width": 60,
      "height": 60
    }
  },
  "image": {
    "@type": "ImageObject",
    "url": "http://localhost:4000/",
    "height": 60,
    "width": 60
  }
}

  </script>
  <link rel="stylesheet" href="/assets/css/styles.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css ">
  <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">

  <!-- <link rel="manifest" href="/manifest.json"> -->
  <!-- <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#efae0a"> -->
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/mstile-144x144.png">
  <meta name="theme-color" content="#233947">

  <!-- Favicon -->
  <link rel="shortcut icon" type="image/x-icon" href="/images/logo/favicon.png">

  <!-- MathJax Config -->
  <!-- Allow inline math using $ and automatically break long math lines -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true,
        processEnvironments: true
    },
    CommonHTML: {
        linebreaks: {
            automatic: true,
        },
    },
});
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_CHTML' async></script>

  <!-- DOM updating function -->
  <script>
const runWhenDOMLoaded = cb => {
  if (document.readyState != 'loading') {
    cb()
  } else if (document.addEventListener) {
    document.addEventListener('DOMContentLoaded', cb)
  } else {
    document.attachEvent('onreadystatechange', function() {
      if (document.readyState == 'complete') cb()
    })
  }
}

// Helper function to init things quickly
initFunction = function(myfunc) {
  runWhenDOMLoaded(myfunc);
  document.addEventListener('turbolinks:load', myfunc);
};
</script>

  <!-- Define some javascript variables that will be useful in other javascript -->
  <script>
    const site_basename = '/';
  </script>

  <!-- Add AnchorJS to let headers be linked -->
  <script src="/assets/js/anchor.min.js"  type="text/javascript"></script>
  <script>

initFunction(function () {
    anchors.add("main h1, main h2, main h3, main h4")
});

</script>

  <!-- Include Turbolinks to make page loads fast -->
  <!-- https://github.com/turbolinks/turbolinks -->
  <script src="/assets/js/turbolinks.js" async></script>
  <meta name="turbolinks-cache-control" content="no-cache">

  <!-- Load nbinteract for widgets -->
  

  <!-- Load Thebelab for interactive widgets -->
  <!-- Include Thebelab for interactive code if it's enabled -->



  <!-- Load the auto-generating TOC -->
  <script src="/assets/js/tocbot.min.js"  type="text/javascript"></script>
  <script>
var initToc = function () {
  tocbot.init({
    tocSelector: 'nav.onthispage',
    contentSelector: '.c-textbook__content',
    headingSelector: 'h2, h3',
    orderedList: false,
    collapseDepth: 6,
    listClass: 'toc__menu',
    activeListItemClass: "",  // Not using
    activeLinkClass: "", // Not using
  });
  tocbot.refresh();
}
initFunction(initToc);
</script>

  <!-- Google analytics -->
  <script src="/assets/js/ga.js" async></script>

  <!-- Clipboard copy button -->
  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" async></script>

  <!-- Load JS that depends on site variables -->
  <script>
/**
 * Set up copy/paste for code blocks
 */
const codeCellId = index => `codecell${index}`

const clipboardButton = id =>
  `<a id="copy-button-${id}" class="btn copybtn o-tooltip--left" data-tooltip="Copy" data-clipboard-target="#${id}">
    <img src="/assets/images/copy-button.svg" alt="Copy to clipboard">
  </a>`

// Clears selected text since ClipboardJS will select the text when copying
const clearSelection = () => {
  if (window.getSelection) {
    window.getSelection().removeAllRanges()
  } else if (document.selection) {
    document.selection.empty()
  }
}

// Changes tooltip text for two seconds, then changes it back
const temporarilyChangeTooltip = (el, newText) => {
  const oldText = el.getAttribute('data-tooltip')
  el.setAttribute('data-tooltip', newText)
  setTimeout(() => el.setAttribute('data-tooltip', oldText), 2000)
}

const addCopyButtonToCodeCells = () => {
  // If ClipboardJS hasn't loaded, wait a bit and try again. This
  // happens because we load ClipboardJS asynchronously.
  if (window.ClipboardJS === undefined) {
    setTimeout(addCopyButtonToCodeCells, 250)
    return
  }

  const codeCells = document.querySelectorAll('div.c-textbook__content > div.highlighter-rouge > div.highlight > pre, div.input_area pre')
  codeCells.forEach((codeCell, index) => {
    const id = codeCellId(index)
    codeCell.setAttribute('id', id)
    if (document.getElementById("copy-button" + id) == null) {
      codeCell.insertAdjacentHTML('afterend', clipboardButton(id));
    }
  })

  const clipboard = new ClipboardJS('.copybtn')
  clipboard.on('success', event => {
    clearSelection()
    temporarilyChangeTooltip(event.trigger, 'Copied!')
  })

  clipboard.on('error', event => {
    temporarilyChangeTooltip(event.trigger, 'Failed to copy')
  })

  // Get rid of clipboard before the next page visit to avoid memory leak
  document.addEventListener('turbolinks:before-visit', () =>
    clipboard.destroy()
  )
}

initFunction(addCopyButtonToCodeCells);
</script>


  <!-- Hide cell code -->
  <script>
    /**
    Add buttons to hide code cells
    */


    var setCodeCellVisibility = function (inputField, kind) {
        // Update the image and class for hidden
        var id = inputField.getAttribute('data-id');
        var codeCell = document.querySelector(`#${id} div.highlight`);

        if (kind === "visible") {
            codeCell.classList.remove('hidden');
            inputField.checked = true;
        } else {
            codeCell.classList.add('hidden');
            inputField.checked = false;
        }
    }

    var toggleCodeCellVisibility = function (event) {
        // The label is clicked, and now we decide what to do based on the input field's clicked status
        if (event.target.tagName === "LABEL") {
            var inputField = event.target.previousElementSibling;
        } else {
            // It is the span inside the target
            var inputField = event.target.parentElement.previousElementSibling;
        }

        if (inputField.checked === true) {
            setCodeCellVisibility(inputField, "visible");
        } else {
            setCodeCellVisibility(inputField, "hidden");
        }
    }


    // Button constructor
    const hideCodeButton = id => `<input class="hidebtn" type="checkbox" id="hidebtn${id}" data-id="${id}"><label title="Toggle cell" for="hidebtn${id}" class="plusminus"><span class="pm_h"></span><span class="pm_v"></span></label>`

    var addHideButton = function () {
        // If a hide button is already added, don't add another
        if (document.querySelector('div.hidecode input') !== null) {
            return;
        }

        // Find the input cells and add a hide button
        document.querySelectorAll('div.input_area').forEach(function (item, index) {
            if (!item.classList.contains("hidecode")) {
                // Skip the cell if it doesn't have a hidecode class
                return;
            }

            const id = codeCellId(index)
            item.setAttribute('id', id);
            // Insert the button just inside the end of the next div
            item.querySelector('div').insertAdjacentHTML('beforeend', hideCodeButton(id))

            // Set up the visibility toggle
            hideLink = document.querySelector(`#${id} div.highlight + input + label`);
            hideLink.addEventListener('click', toggleCodeCellVisibility)
        });
    }


    // Initialize the hide buttos
    var initHiddenCells = function () {
        // Add hide buttons to the cells
        addHideButton();

        // Toggle the code cells that should be hidden
        document.querySelectorAll('div.hidecode input').forEach(function (item) {
            setCodeCellVisibility(item, 'hidden');
            item.checked = true;
        })
    }

    initFunction(initHiddenCells);

</script>

  <!-- Load custom website scripts -->
  <script src="/assets/js/scripts.js" async></script>

  <!-- Load custom user CSS and JS  -->
  <script src="/assets/custom/custom.js" async></script>
  <link rel="stylesheet" href="/assets/custom/custom.css">

  <!-- Update interact links w/ REST param, is defined in includes so we can use templates -->
  

  <!-- Lunr search code - will only be executed on the /search page -->
  <script src="/assets/js/lunr/lunr.min.js" type="text/javascript"></script>
  <script>var initQuery = function() {
  // See if we have a search box
  var searchInput = document.querySelector('input#lunr_search');
  if (searchInput === null) {
    return;
  }

  // Function to parse our lunr cache
  var idx = lunr(function () {
    this.field('title')
    this.field('excerpt')
    this.field('categories')
    this.field('tags')
    this.ref('id')

    this.pipeline.remove(lunr.trimmer)

    for (var item in store) {
      this.add({
        title: store[item].title,
        excerpt: store[item].excerpt,
        categories: store[item].categories,
        tags: store[item].tags,
        id: item
      })
    }
  });

  // Run search upon keyup
  searchInput.addEventListener('keyup', function () {
    var resultdiv = document.querySelector('#results');
    var query = document.querySelector("input#lunr_search").value.toLowerCase();
    var result =
      idx.query(function (q) {
        query.split(lunr.tokenizer.separator).forEach(function (term) {
          q.term(term, { boost: 100 })
          if(query.lastIndexOf(" ") != query.length-1){
            q.term(term, {  usePipeline: false, wildcard: lunr.Query.wildcard.TRAILING, boost: 10 })
          }
          if (term != ""){
            q.term(term, {  usePipeline: false, editDistance: 1, boost: 1 })
          }
        })
      });

      // Empty the results div
      while (resultdiv.firstChild) {
        resultdiv.removeChild(resultdiv.firstChild);
      }

    resultdiv.insertAdjacentHTML('afterbegin', '<p class="results__found">'+result.length+' Result(s) found</p>');
    for (var item in result) {
      var ref = result[item].ref;
      if(store[ref].teaser){
        var searchitem =
          '<div class="list__item">'+
            '<article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">'+
              '<h2 class="archive__item-title" itemprop="headline">'+
                '<a href="'+store[ref].url+'" rel="permalink">'+store[ref].title+'</a>'+
              '</h2>'+
              '<div class="archive__item-teaser">'+
                '<img src="'+store[ref].teaser+'" alt="">'+
              '</div>'+
              '<p class="archive__item-excerpt" itemprop="description">'+store[ref].excerpt.split(" ").splice(0,20).join(" ")+'...</p>'+
            '</article>'+
          '</div>';
      }
      else{
    	  var searchitem =
          '<div class="list__item">'+
            '<article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">'+
              '<h2 class="archive__item-title" itemprop="headline">'+
                '<a href="'+store[ref].url+'" rel="permalink">'+store[ref].title+'</a>'+
              '</h2>'+
              '<p class="archive__item-excerpt" itemprop="description">'+store[ref].excerpt.split(" ").splice(0,20).join(" ")+'...</p>'+
            '</article>'+
          '</div>';
      }
      resultdiv.insertAdjacentHTML('beforeend', searchitem);
    }
  });
};

initFunction(initQuery);
</script>
</head>

  <body>
    <!-- .js-show-sidebar shows sidebar by default -->
    <div id="js-textbook" class="c-textbook js-show-sidebar">
      



<nav id="js-sidebar" class="c-textbook__sidebar">
  <a href="https://rpi.analyticsdojo.com"><img src="/images/logo/rpi.png" class="textbook_logo" id="sidebar-logo" data-turbolinks-permanent/></a>
  <h2 class="c-sidebar__title">MGMT6560 Fall 19</h2>
  <ul class="c-sidebar__chapters">
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/index.html"
        >
          
          Home
        </a>

        
      </li>

      
    
      
      
        <li class="c-sidebar__chapter"><a class="c-sidebar__entry" href="/search.html">Search</a></li>
        
      
      
        <li class="c-sidebar__divider"></li>
        
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/sessions/index.html"
        >
          
          Schedule
        </a>

        

          
          
          
          

          

          <ul class="c-sidebar__sections u-hidden-visually">
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/readings.html"
                >
                  
                  All Readings
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session1.html"
                >
                  
                  Session 1
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session2.html"
                >
                  
                  Session 2
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session3.html"
                >
                  
                  Session 3
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session4.html"
                >
                  
                  Session 4
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session5.html"
                >
                  
                  Session 5
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session6.html"
                >
                  
                  Session 6
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session7.html"
                >
                  
                  Session 7
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session8.html"
                >
                  
                  Session 8
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session9.html"
                >
                  
                  Session 9
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session10.html"
                >
                  
                  Session 10
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session11.html"
                >
                  
                  Session 11
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session12.html"
                >
                  
                  Session 12
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session13.html"
                >
                  
                  Session 13
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session14.html"
                >
                  
                  Session 14
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session15.html"
                >
                  
                  Session 15
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session16.html"
                >
                  
                  Session 16
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session17.html"
                >
                  
                  Session 17
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session18.html"
                >
                  
                  Session 18
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session19.html"
                >
                  
                  Session 19
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session20.html"
                >
                  
                  Session 20
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session21.html"
                >
                  
                  Session 21
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session22.html"
                >
                  
                  Session 22
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session23.html"
                >
                  
                  Session 23
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session24.html"
                >
                  
                  Session 24
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session25.html"
                >
                  
                  Session 25
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session26.html"
                >
                  
                  Session 26
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session27.html"
                >
                  
                  Session 27
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session28.html"
                >
                  
                  Session 28
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/sessions/session29.html"
                >
                  
                  Session 29
                </a>

                
                

              </li>
              
            
          </ul>
        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/notebooks/index.html"
        >
          
          Notebooks
        </a>

        

          
          
          
          

          

          <ul class="c-sidebar__sections ">
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/02-intro-python/01-intro-python-overview.html"
                >
                  
                  Python Overview
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/02-intro-python/02-intro-python-datastructures.html"
                >
                  
                  Basic Data Structures
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/02-intro-python/03-intro-python-numpy.html"
                >
                  
                  Numpy
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/02-intro-python/04-intro-python-pandas.html"
                >
                  
                  Pandas
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/04-python/01-intro-python-conditionals-loops.html"
                >
                  
                  Conditional-Loops
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/04-python/02-intro-python-functions.html"
                >
                  
                  Functions
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/04-python/03-intro-python-null-values.html"
                >
                  
                  Null Values
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/04-python/04-intro-python-groupby.html"
                >
                  
                  Groupby and Pivot Tables
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/04-python/05-intro-kaggle-baseline.html"
                >
                  
                  Kaggle Baseline
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/06-viz-api-scraper/01-intro-api-twitter.html"
                >
                  
                  Twitter
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/06-viz-api-scraper/02-intro-python-webmining.html"
                >
                  
                  Web Mining
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/06-viz-api-scraper/03-visualization-python-seaborn.html"
                >
                  
                  Visualizations - Seaborn
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/06-viz-api-scraper/04-strings-regular-expressions.html"
                >
                  
                  Strings - Regular Expressions
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/06-viz-api-scraper/05-features-dummies.html"
                >
                  
                  Feature Dummies
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/06-viz-api-scraper/ALT-visualization-python-matplotlib.html"
                >
                  
                  Matplotlib
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/08-intro-modeling/01-neural-networks.html"
                >
                  
                  The Simplest Neural Network with Numpy
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/08-intro-modeling/02-train-test-split.html"
                >
                  
                  Train Test Split
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/08-intro-modeling/03-intro-logistic-knn.html"
                >
                  
                  Introduction to Logistic Regression
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/08-intro-modeling/04-knn.html"
                >
                  
                  K Nearest Neighbor
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/assignments/05-starter.html"
                >
                  
                  Assignment 5
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/10-intro-r/01-intro-r-overview.html"
                >
                  
                  Introduction to R
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/10-intro-r/02-intro-r-localfile.html"
                >
                  
                  Local Files
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/10-intro-r/03-intro-r-datastructures.html"
                >
                  
                  Data Structures
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/10-intro-r/04-intro-r-dataframes.html"
                >
                  
                  Dataframes
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/10-intro-r/05-intro-r-functions.html"
                >
                  
                  Functions
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/10-intro-r/06-intro-r-conditionals-loops.html"
                >
                  
                  Conditional-Loops
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/10-intro-r/07-intro-r-merge-agg-fun.html"
                >
                  
                  Aggregation and Merge
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/10-intro-r/08-intro-r-tidyverse.html"
                >
                  
                  Tidyvere
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/10-intro-r/09-titanic-intro.html"
                >
                  
                  Titanic
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/12-intro-modeling-2/01-matrix-regression-gradient-decent-python.html"
                >
                  
                  Regression - Matrix
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/12-intro-modeling-2/02-regression-boston-housing-python.html"
                >
                  
                  Boston Housing
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/12-intro-modeling-2/03-ridge-lasso-python.html"
                >
                  
                  Ridge and Lasso
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/12-intro-modeling-2/04-stats-models.html"
                >
                  
                  Stats Models
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/14-unsupervised/01-introduction-pca.html"
                >
                  
                  PCA
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/14-unsupervised/02-pca2.html"
                >
                  
                  PCA Alt
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/14-unsupervised/03-kmeans.html"
                >
                  
                  Cluster Analysis
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/14-unsupervised/04-regression-feature-selection.html"
                >
                  
                  Feature Selection and Importance
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/16-intro-nlp/01-titanic-features.html"
                >
                  
                  Titanic Feature Creation
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/16-intro-nlp/02-corpus-simple.html"
                >
                  
                  Corpus Simple
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/16-intro-nlp/03-scikit-learn-text.html"
                >
                  
                  Scikit Learn Text
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/16-intro-nlp/04-what-cooking-python.html"
                >
                  
                  What's Cooking Python
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/16-intro-nlp/05-bag-popcorn-bag-words.html"
                >
                  
                  Bag of Popcorn Bag of Words
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/16-intro-nlp/06-sentiment.html"
                >
                  
                  Sentiment
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/16-intro-nlp/02-intro-nlp.html"
                >
                  
                  Overview of NLP
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/16-intro-nlp/07-fastai-imdb.html"
                >
                  
                  FAST.ai NLP
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/18-big-data/01-intro-mapreduce.html"
                >
                  
                  Intoduction to MapReduce
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/18-big-data/02-intro-spark.html"
                >
                  
                  Introduction to Spark
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/18-intro-timeseries/01-time-series.html"
                >
                  
                  Introduction to Time Series
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/18-intro-timeseries/02-forcasting-rossman.html"
                >
                  
                  Rossman Store Sales
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/20-deep-learning1/01-neural-networks.html"
                >
                  
                  Neural Networks
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/20-deep-learning1/02-tensor-tutorial.html"
                >
                  
                  Tensors
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/20-deep-learning1/03-pytorch-iris.html"
                >
                  
                  Pytorch IRIS
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/20-deep-learning1/04-covnet-tutorial.html"
                >
                  
                  Covnet
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/20-deep-learning1/05-pytorch-mnist.html"
                >
                  
                  Pytorch Mnist
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/20-deep-learning1/06-regression-bh-pytorch.html"
                >
                  
                  Regression
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/20-deep-learning1/07-titanic-fastai.html"
                >
                  
                  Titanic FastAI
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/20-deep-learning1/08-ludwig.html"
                >
                  
                  Ludwig
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/20-deep-learning1/09-evaluation.html"
                >
                  
                  Evaluation
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/24-tensorflow/10_neural_nets_with_keras.html"
                >
                  
                  TF-Keras
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/24-tensorflow/11_training_deep_neural_networks.html"
                >
                  
                  TF-training
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry c-sidebar__entry--active"
                  href="/notebooks/24-tensorflow/13_loading_and_preprocessing_data.html"
                >
                  
                  TF-data
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/24-tensorflow/14_deep_computer_vision_with_cnns.html"
                >
                  
                  TF-CNN
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/24-tensorflow/15_processing_sequences_using_rnns_and_cnns.html"
                >
                  
                  TF-RNN
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/24-tensorflow/16_nlp_with_rnns_and_attention.html"
                >
                  
                  TF-NLP
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/notebooks/24-tensorflow/17_autoencoders_and_gans.html"
                >
                  
                  TF-Autoencoder and Gan
                </a>

                
                

              </li>
              
            
          </ul>
        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/assignments/index.html"
        >
          
          Assignments
        </a>

        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/grading.html"
        >
          
          Grading
        </a>

        
      </li>

      
    
      
      
        <li class="c-sidebar__divider"></li>
        
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="https://colab.research.google.com"
        >
          
          Google Colab
        </a>

        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="https://www.dropbox.com/sh/n34sld9qjxyc2xi/AADTrNLgPlu2FNVEhHG04Qqxa?dl=0"
        >
          
          Dropbox - Presentations/Files
        </a>

        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="https://github.com/RPI-DATA/course-intro-ml-app/tree/master/content"
        >
          
          Github - Class Content
        </a>

        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="https://github.com/orgs/rpi-intro-ml-app-fall-2019/"
        >
          
          Github - Assignments
        </a>

        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="https://piazza.com/class/jzeez8noxxl7eh"
        >
          
          Piazza (Section 2 Communications)
        </a>

        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="https://rpibsan2020.slack.com/"
        >
          
          Slack (Section 1 Communications)
        </a>

        
      </li>

      
    
  </ul>
  <p class="sidebar_footer">Powered by <a href="https://github.com/jupyter/jupyter-book">Jupyter Book</a></p>
</nav>

      
      <!-- Empty sidebar placeholder that we'll auto-fill with javascript -->
      <aside class="sidebar__right">
          <header><h4 class="nav__title"><i class="fa fa-list"></i>   On this page</h4></header>
          <nav class="onthispage">
          </nav>
      </aside>
      
      <main class="c-textbook__page" tabindex="-1">
          <div class="o-wrapper">
            <div class="c-sidebar-toggle">
  <!-- We show the sidebar by default so we use .is-active -->
  <button
    id="js-sidebar-toggle"
    class="hamburger hamburger--arrowalt is-active"
  >
    <span class="hamburger-box">
      <span class="hamburger-inner"></span>
    </span>
    <span class="c-sidebar-toggle__label">Toggle Sidebar</span>
  </button>
</div>

            
<div class="buttons">
<a href="/content/notebooks/24-tensorflow/13_loading_and_preprocessing_data.ipynb" download>
<button id="interact-button-download" class="interact-button">Download</button>
</a>






</div>


            <div class="c-textbook__content">
              <p><strong>Chapter 13 – Loading and Preprocessing Data with TensorFlow</strong></p>

<p><em>This notebook contains all the sample code and solutions to the exercises in chapter 13.</em></p>

<table align="left">
  <td>
    <a target="_blank" href="https://colab.research.google.com/github/ageron/handson-ml2/blob/master/13_loading_and_preprocessing_data.ipynb"><img src="https://www.tensorflow.org/images/colab_logo_32px.png" />Run in Google Colab</a>
  </td>
</table>

<h1 id="setup">Setup</h1>

<p>First, let’s import a few common modules, ensure MatplotLib plots figures inline and prepare a function to save the figures. We also check that Python 3.5 or later is installed (although Python 2.x may work, it is deprecated so we strongly recommend you use Python 3 instead), as well as Scikit-Learn ≥0.20 and TensorFlow ≥2.0.</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Python ≥3.5 is required
</span><span class="kn">import</span> <span class="nn">sys</span>
<span class="k">assert</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="c1"># Scikit-Learn ≥0.20 is required
</span><span class="kn">import</span> <span class="nn">sklearn</span>
<span class="k">assert</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&gt;=</span> <span class="s">"0.20"</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># %tensorflow_version only exists in Colab.
</span>    <span class="o">%</span><span class="n">tensorflow_version</span> <span class="mf">2.</span><span class="n">x</span>
    <span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="o">-</span><span class="n">U</span> <span class="n">tfx</span><span class="o">==</span><span class="mf">0.15.0</span><span class="n">rc0</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"You can safely ignore the package incompatibility errors."</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="c1"># TensorFlow ≥2.0 is required
</span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="k">assert</span> <span class="n">tf</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&gt;=</span> <span class="s">"2.0"</span>

<span class="c1"># Common imports
</span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># to make this notebook's output stable across runs
</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># To plot pretty figures
</span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="n">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s">'axes'</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s">'xtick'</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s">'ytick'</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># Where to save the figures
</span><span class="n">PROJECT_ROOT_DIR</span> <span class="o">=</span> <span class="s">"."</span>
<span class="n">CHAPTER_ID</span> <span class="o">=</span> <span class="s">"data"</span>
<span class="n">IMAGES_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_ROOT_DIR</span><span class="p">,</span> <span class="s">"images"</span><span class="p">,</span> <span class="n">CHAPTER_ID</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">IMAGES_PATH</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">save_fig</span><span class="p">(</span><span class="n">fig_id</span><span class="p">,</span> <span class="n">tight_layout</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">fig_extension</span><span class="o">=</span><span class="s">"png"</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IMAGES_PATH</span><span class="p">,</span> <span class="n">fig_id</span> <span class="o">+</span> <span class="s">"."</span> <span class="o">+</span> <span class="n">fig_extension</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Saving figure"</span><span class="p">,</span> <span class="n">fig_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tight_layout</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">fig_extension</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">resolution</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<h2 id="datasets">Datasets</h2>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">X</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">dataset</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">

      <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;TensorSliceDataset shapes: (), types: tf.int32&gt;
</code></pre></div>      </div>

    </div>
  </div>
</div>

<p>Equivalently:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">
      <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tf.Tensor(0, shape=(), dtype=int64)
tf.Tensor(1, shape=(), dtype=int64)
tf.Tensor(2, shape=(), dtype=int64)
tf.Tensor(3, shape=(), dtype=int64)
tf.Tensor(4, shape=(), dtype=int64)
tf.Tensor(5, shape=(), dtype=int64)
tf.Tensor(6, shape=(), dtype=int64)
tf.Tensor(7, shape=(), dtype=int64)
tf.Tensor(8, shape=(), dtype=int64)
tf.Tensor(9, shape=(), dtype=int64)
</code></pre></div>      </div>
    </div>
  </div>
</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">
      <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tf.Tensor([0 1 2 3 4 5 6], shape=(7,), dtype=int64)
tf.Tensor([7 8 9 0 1 2 3], shape=(7,), dtype=int64)
tf.Tensor([4 5 6 7 8 9 0], shape=(7,), dtype=int64)
tf.Tensor([1 2 3 4 5 6 7], shape=(7,), dtype=int64)
tf.Tensor([8 9], shape=(2,), dtype=int64)
</code></pre></div>      </div>
    </div>
  </div>
</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">
      <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tf.Tensor([ 0  2  4  6  8 10 12], shape=(7,), dtype=int64)
tf.Tensor([14 16 18  0  2  4  6], shape=(7,), dtype=int64)
tf.Tensor([ 8 10 12 14 16 18  0], shape=(7,), dtype=int64)
tf.Tensor([ 2  4  6  8 10 12 14], shape=(7,), dtype=int64)
tf.Tensor([16 18], shape=(2,), dtype=int64)
</code></pre></div>      </div>
    </div>
  </div>
</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">unbatch</span><span class="p">())</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># keep only items &lt; 10
</span>
</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">
      <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tf.Tensor(0, shape=(), dtype=int64)
tf.Tensor(2, shape=(), dtype=int64)
tf.Tensor(4, shape=(), dtype=int64)
</code></pre></div>      </div>
    </div>
  </div>
</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">
      <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tf.Tensor([0 3 4 2 1 5 8], shape=(7,), dtype=int64)
tf.Tensor([6 9 7 2 3 1 4], shape=(7,), dtype=int64)
tf.Tensor([6 0 7 9 0 1 2], shape=(7,), dtype=int64)
tf.Tensor([8 4 5 5 3 8 9], shape=(7,), dtype=int64)
tf.Tensor([7 6], shape=(2,), dtype=int64)
</code></pre></div>      </div>
    </div>
  </div>
</div>

<h2 id="split-the-california-dataset-to-multiple-csv-files">Split the California dataset to multiple CSV files</h2>

<p>Let’s start by loading and preparing the California housing dataset. We first load it, then split it into a training set, a validation set and a test set, and finally we scale it:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">fetch_california_housing</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="n">housing</span> <span class="o">=</span> <span class="n">fetch_california_housing</span><span class="p">()</span>
<span class="n">X_train_full</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train_full</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">housing</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">housing</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_valid</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X_train_full</span><span class="p">,</span> <span class="n">y_train_full</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_mean</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">mean_</span>
<span class="n">X_std</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">scale_</span>

</code></pre></div>    </div>
  </div>

</div>

<p>For a very large dataset that does not fit in memory, you will typically want to split it into many files first, then have TensorFlow read these files in parallel. To demonstrate this, let’s start by splitting the housing dataset and save it to 20 CSV files:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">save_to_multiple_csv_files</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name_prefix</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">n_parts</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">housing_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">"datasets"</span><span class="p">,</span> <span class="s">"housing"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">housing_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">path_format</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">housing_dir</span><span class="p">,</span> <span class="s">"my_{}_{:02d}.csv"</span><span class="p">)</span>

    <span class="n">filepaths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file_idx</span><span class="p">,</span> <span class="n">row_indices</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">n_parts</span><span class="p">)):</span>
        <span class="n">part_csv</span> <span class="o">=</span> <span class="n">path_format</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">name_prefix</span><span class="p">,</span> <span class="n">file_idx</span><span class="p">)</span>
        <span class="n">filepaths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part_csv</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">part_csv</span><span class="p">,</span> <span class="s">"wt"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row_idx</span> <span class="ow">in</span> <span class="n">row_indices</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">","</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">repr</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">row_idx</span><span class="p">]]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filepaths</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">]</span>
<span class="n">valid_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">]</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">]</span>
<span class="n">header_cols</span> <span class="o">=</span> <span class="n">housing</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">+</span> <span class="p">[</span><span class="s">"MedianHouseValue"</span><span class="p">]</span>
<span class="n">header</span> <span class="o">=</span> <span class="s">","</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">header_cols</span><span class="p">)</span>

<span class="n">train_filepaths</span> <span class="o">=</span> <span class="n">save_to_multiple_csv_files</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="s">"train"</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">n_parts</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">valid_filepaths</span> <span class="o">=</span> <span class="n">save_to_multiple_csv_files</span><span class="p">(</span><span class="n">valid_data</span><span class="p">,</span> <span class="s">"valid"</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">n_parts</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">test_filepaths</span> <span class="o">=</span> <span class="n">save_to_multiple_csv_files</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="s">"test"</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">n_parts</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<p>Okay, now let’s take a peek at the first few lines of one of these CSV files:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">train_filepaths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">

      <div class="output output_html">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>MedInc</th>
      <th>HouseAge</th>
      <th>AveRooms</th>
      <th>AveBedrms</th>
      <th>Population</th>
      <th>AveOccup</th>
      <th>Latitude</th>
      <th>Longitude</th>
      <th>MedianHouseValue</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3.5214</td>
      <td>15.0</td>
      <td>3.049945</td>
      <td>1.106548</td>
      <td>1447.0</td>
      <td>1.605993</td>
      <td>37.63</td>
      <td>-122.43</td>
      <td>1.442</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5.3275</td>
      <td>5.0</td>
      <td>6.490060</td>
      <td>0.991054</td>
      <td>3464.0</td>
      <td>3.443340</td>
      <td>33.69</td>
      <td>-117.39</td>
      <td>1.687</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3.1000</td>
      <td>29.0</td>
      <td>7.542373</td>
      <td>1.591525</td>
      <td>1328.0</td>
      <td>2.250847</td>
      <td>38.44</td>
      <td>-122.98</td>
      <td>1.621</td>
    </tr>
    <tr>
      <th>3</th>
      <td>7.1736</td>
      <td>12.0</td>
      <td>6.289003</td>
      <td>0.997442</td>
      <td>1054.0</td>
      <td>2.695652</td>
      <td>33.55</td>
      <td>-117.70</td>
      <td>2.621</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2.0549</td>
      <td>13.0</td>
      <td>5.312457</td>
      <td>1.085092</td>
      <td>3297.0</td>
      <td>2.244384</td>
      <td>33.93</td>
      <td>-116.93</td>
      <td>0.956</td>
    </tr>
  </tbody>
</table>
</div>
</div>

    </div>
  </div>
</div>

<p>Or in text mode:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">train_filepaths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s">""</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">
      <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MedInc,HouseAge,AveRooms,AveBedrms,Population,AveOccup,Latitude,Longitude,MedianHouseValue
3.5214,15.0,3.0499445061043287,1.106548279689234,1447.0,1.6059933407325193,37.63,-122.43,1.442
5.3275,5.0,6.490059642147117,0.9910536779324056,3464.0,3.4433399602385686,33.69,-117.39,1.687
3.1,29.0,7.5423728813559325,1.5915254237288134,1328.0,2.2508474576271187,38.44,-122.98,1.621
7.1736,12.0,6.289002557544757,0.9974424552429667,1054.0,2.6956521739130435,33.55,-117.7,2.621
</code></pre></div>      </div>
    </div>
  </div>
</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_filepaths</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">

      <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>['datasets/housing/my_train_00.csv',
 'datasets/housing/my_train_01.csv',
 'datasets/housing/my_train_02.csv',
 'datasets/housing/my_train_03.csv',
 'datasets/housing/my_train_04.csv',
 'datasets/housing/my_train_05.csv',
 'datasets/housing/my_train_06.csv',
 'datasets/housing/my_train_07.csv',
 'datasets/housing/my_train_08.csv',
 'datasets/housing/my_train_09.csv',
 'datasets/housing/my_train_10.csv',
 'datasets/housing/my_train_11.csv',
 'datasets/housing/my_train_12.csv',
 'datasets/housing/my_train_13.csv',
 'datasets/housing/my_train_14.csv',
 'datasets/housing/my_train_15.csv',
 'datasets/housing/my_train_16.csv',
 'datasets/housing/my_train_17.csv',
 'datasets/housing/my_train_18.csv',
 'datasets/housing/my_train_19.csv']
</code></pre></div>      </div>

    </div>
  </div>
</div>

<h2 id="building-an-input-pipeline">Building an Input Pipeline</h2>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">filepath_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">list_files</span><span class="p">(</span><span class="n">train_filepaths</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">filepath_dataset</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">
      <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tf.Tensor(b'datasets/housing/my_train_05.csv', shape=(), dtype=string)
tf.Tensor(b'datasets/housing/my_train_16.csv', shape=(), dtype=string)
tf.Tensor(b'datasets/housing/my_train_01.csv', shape=(), dtype=string)
tf.Tensor(b'datasets/housing/my_train_17.csv', shape=(), dtype=string)
tf.Tensor(b'datasets/housing/my_train_00.csv', shape=(), dtype=string)
tf.Tensor(b'datasets/housing/my_train_14.csv', shape=(), dtype=string)
tf.Tensor(b'datasets/housing/my_train_10.csv', shape=(), dtype=string)
tf.Tensor(b'datasets/housing/my_train_02.csv', shape=(), dtype=string)
tf.Tensor(b'datasets/housing/my_train_12.csv', shape=(), dtype=string)
tf.Tensor(b'datasets/housing/my_train_19.csv', shape=(), dtype=string)
tf.Tensor(b'datasets/housing/my_train_07.csv', shape=(), dtype=string)
tf.Tensor(b'datasets/housing/my_train_09.csv', shape=(), dtype=string)
tf.Tensor(b'datasets/housing/my_train_13.csv', shape=(), dtype=string)
tf.Tensor(b'datasets/housing/my_train_15.csv', shape=(), dtype=string)
tf.Tensor(b'datasets/housing/my_train_11.csv', shape=(), dtype=string)
tf.Tensor(b'datasets/housing/my_train_18.csv', shape=(), dtype=string)
tf.Tensor(b'datasets/housing/my_train_04.csv', shape=(), dtype=string)
tf.Tensor(b'datasets/housing/my_train_06.csv', shape=(), dtype=string)
tf.Tensor(b'datasets/housing/my_train_03.csv', shape=(), dtype=string)
tf.Tensor(b'datasets/housing/my_train_08.csv', shape=(), dtype=string)
</code></pre></div>      </div>
    </div>
  </div>
</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n_readers</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">filepath_dataset</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">filepath</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TextLineDataset</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">cycle_length</span><span class="o">=</span><span class="n">n_readers</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">
      <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>b'4.2083,44.0,5.323204419889502,0.9171270718232044,846.0,2.3370165745856353,37.47,-122.2,2.782'
b'4.1812,52.0,5.701388888888889,0.9965277777777778,692.0,2.4027777777777777,33.73,-118.31,3.215'
b'3.6875,44.0,4.524475524475524,0.993006993006993,457.0,3.195804195804196,34.04,-118.15,1.625'
b'3.3456,37.0,4.514084507042254,0.9084507042253521,458.0,3.2253521126760565,36.67,-121.7,2.526'
b'3.5214,15.0,3.0499445061043287,1.106548279689234,1447.0,1.6059933407325193,37.63,-122.43,1.442'
</code></pre></div>      </div>
    </div>
  </div>
</div>

<p>Notice that field 4 is interpreted as a string.</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">record_defaults</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="s">"Hello"</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([])]</span>
<span class="n">parsed_fields</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">decode_csv</span><span class="p">(</span><span class="s">'1,2,3,4,5'</span><span class="p">,</span> <span class="n">record_defaults</span><span class="p">)</span>
<span class="n">parsed_fields</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">

      <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[&lt;tf.Tensor: id=245, shape=(), dtype=int32, numpy=1&gt;,
 &lt;tf.Tensor: id=246, shape=(), dtype=float32, numpy=2.0&gt;,
 &lt;tf.Tensor: id=247, shape=(), dtype=float64, numpy=3.0&gt;,
 &lt;tf.Tensor: id=248, shape=(), dtype=string, numpy=b'4'&gt;,
 &lt;tf.Tensor: id=249, shape=(), dtype=float32, numpy=5.0&gt;]
</code></pre></div>      </div>

    </div>
  </div>
</div>

<p>Notice that all missing fields are replaced with their default value, when provided:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parsed_fields</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">decode_csv</span><span class="p">(</span><span class="s">',,,,5'</span><span class="p">,</span> <span class="n">record_defaults</span><span class="p">)</span>
<span class="n">parsed_fields</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">

      <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[&lt;tf.Tensor: id=259, shape=(), dtype=int32, numpy=0&gt;,
 &lt;tf.Tensor: id=260, shape=(), dtype=float32, numpy=nan&gt;,
 &lt;tf.Tensor: id=261, shape=(), dtype=float64, numpy=nan&gt;,
 &lt;tf.Tensor: id=262, shape=(), dtype=string, numpy=b'Hello'&gt;,
 &lt;tf.Tensor: id=263, shape=(), dtype=float32, numpy=5.0&gt;]
</code></pre></div>      </div>

    </div>
  </div>
</div>

<p>The 5th field is compulsory (since we provided <code class="language-plaintext highlighter-rouge">tf.constant([])</code> as the “default value”), so we get an exception if we do not provide it:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span><span class="p">:</span>
    <span class="n">parsed_fields</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">decode_csv</span><span class="p">(</span><span class="s">',,,,'</span><span class="p">,</span> <span class="n">record_defaults</span><span class="p">)</span>
<span class="k">except</span> <span class="n">tf</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidArgumentError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">
      <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Field 4 is required but missing in record 0! [Op:DecodeCSV]
</code></pre></div>      </div>
    </div>
  </div>
</div>

<p>The number of fields should match exactly the number of fields in the <code class="language-plaintext highlighter-rouge">record_defaults</code>:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span><span class="p">:</span>
    <span class="n">parsed_fields</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">decode_csv</span><span class="p">(</span><span class="s">'1,2,3,4,5,6,7'</span><span class="p">,</span> <span class="n">record_defaults</span><span class="p">)</span>
<span class="k">except</span> <span class="n">tf</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidArgumentError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">
      <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Expect 5 fields but have 7 in record 0 [Op:DecodeCSV]
</code></pre></div>      </div>
    </div>
  </div>
</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n_inputs</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1"># X_train.shape[-1]
</span>
<span class="o">@</span><span class="n">tf</span><span class="o">.</span><span class="n">function</span>
<span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">defs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_inputs</span> <span class="o">+</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)]</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">decode_csv</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">record_defaults</span><span class="o">=</span><span class="n">defs</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">fields</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">X_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">X_std</span><span class="p">,</span> <span class="n">y</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">preprocess</span><span class="p">(</span><span class="n">b</span><span class="s">'4.2083,44.0,5.3232,0.9171,846.0,2.3370,37.47,-122.2,2.782'</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">

      <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(&lt;tf.Tensor: id=307, shape=(8,), dtype=float32, numpy=
 array([ 0.16579157,  1.216324  , -0.05204565, -0.39215982, -0.5277444 ,
        -0.2633488 ,  0.8543046 , -1.3072058 ], dtype=float32)&gt;,
 &lt;tf.Tensor: id=308, shape=(1,), dtype=float32, numpy=array([2.782], dtype=float32)&gt;)
</code></pre></div>      </div>

    </div>
  </div>
</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">csv_reader_dataset</span><span class="p">(</span><span class="n">filepaths</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_readers</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                       <span class="n">n_read_threads</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">shuffle_buffer_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                       <span class="n">n_parse_threads</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">list_files</span><span class="p">(</span><span class="n">filepaths</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeat</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">filepath</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TextLineDataset</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">cycle_length</span><span class="o">=</span><span class="n">n_readers</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">n_read_threads</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">shuffle_buffer_size</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">preprocess</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">n_parse_threads</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_set</span> <span class="o">=</span> <span class="n">csv_reader_dataset</span><span class="p">(</span><span class="n">train_filepaths</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="k">for</span> <span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span> <span class="ow">in</span> <span class="n">train_set</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"X ="</span><span class="p">,</span> <span class="n">X_batch</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"y ="</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">)</span>
    <span class="k">print</span><span class="p">()</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">
      <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>X = tf.Tensor(
[[-1.1309323   0.5834586  -1.1141092  -0.0205977   0.4861637   0.05622157
  -0.72447133  0.63188833]
 [ 1.9003258  -0.998705    0.6331733  -0.03226789  0.05084941 -0.28879014
   1.0229574  -1.2872185 ]
 [-0.08566543 -1.6315705   0.04572354 -0.16350564  0.18226504  0.09547261
  -0.92123175  0.65187943]], shape=(3, 8), dtype=float32)
y = tf.Tensor(
[[2.219]
 [3.702]
 [2.875]], shape=(3, 1), dtype=float32)

X = tf.Tensor(
[[ 0.92681414 -1.0778131   0.194918   -0.2745752  -0.02215928  0.13869788
   1.2525111  -1.5520943 ]
 [ 0.12441459 -2.0271113  -0.0920579  -0.17962678 -0.38263968  0.11107364
  -1.3007004   1.9912548 ]
 [-0.10782045  1.8491895  -0.01604682  0.04678809 -0.33609664 -0.2658364
   0.9807942  -1.4471437 ]], shape=(3, 8), dtype=float32)
y = tf.Tensor(
[[1.724]
 [0.832]
 [3.118]], shape=(3, 1), dtype=float32)

</code></pre></div>      </div>
    </div>
  </div>
</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_set</span> <span class="o">=</span> <span class="n">csv_reader_dataset</span><span class="p">(</span><span class="n">train_filepaths</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="n">valid_set</span> <span class="o">=</span> <span class="n">csv_reader_dataset</span><span class="p">(</span><span class="n">valid_filepaths</span><span class="p">)</span>
<span class="n">test_set</span> <span class="o">=</span> <span class="n">csv_reader_dataset</span><span class="p">(</span><span class="n">test_filepaths</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">"relu"</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="p">])</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s">"mse"</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">))</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_set</span><span class="p">,</span> <span class="n">steps_per_epoch</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="n">valid_set</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">
      <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Epoch 1/10
362/362 [==============================] - 1s 3ms/step - loss: 2.4158 - val_loss: 0.9218
Epoch 2/10
362/362 [==============================] - 1s 2ms/step - loss: 0.7571 - val_loss: 0.6992
Epoch 3/10
362/362 [==============================] - 1s 2ms/step - loss: 0.6767 - val_loss: 0.6532
Epoch 4/10
362/362 [==============================] - 1s 2ms/step - loss: 0.6406 - val_loss: 0.6751
Epoch 5/10
362/362 [==============================] - 1s 2ms/step - loss: 0.6012 - val_loss: 0.5904
Epoch 6/10
362/362 [==============================] - 1s 2ms/step - loss: 0.5792 - val_loss: 0.6392
Epoch 7/10
362/362 [==============================] - 1s 2ms/step - loss: 0.5531 - val_loss: 0.5686
Epoch 8/10
362/362 [==============================] - 1s 2ms/step - loss: 0.5050 - val_loss: 0.5086
Epoch 9/10
362/362 [==============================] - 1s 2ms/step - loss: 0.5039 - val_loss: 0.4825
Epoch 10/10
362/362 [==============================] - 1s 2ms/step - loss: 0.4930 - val_loss: 0.4761
</code></pre></div>      </div>
    </div>
  </div>
  <div class="output_wrapper">
    <div class="output_subarea">

      <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;tensorflow.python.keras.callbacks.History at 0x131194e48&gt;
</code></pre></div>      </div>

    </div>
  </div>
</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_set</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">
      <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>161/161 [==============================] - 0s 1ms/step - loss: 0.4804
</code></pre></div>      </div>
    </div>
  </div>
  <div class="output_wrapper">
    <div class="output_subarea">

      <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0.4803512151937307
</code></pre></div>      </div>

    </div>
  </div>
</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">new_set</span> <span class="o">=</span> <span class="n">test_set</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">X</span><span class="p">)</span> <span class="c1"># we could instead just pass test_set, Keras would ignore the labels
</span><span class="n">X_new</span> <span class="o">=</span> <span class="n">X_test</span>
<span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">new_set</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">X_new</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">

      <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>array([[2.5751495],
       [2.1568842],
       [2.019339 ],
       ...,
       [3.553556 ],
       [2.2041245],
       [2.366016 ]], dtype=float32)
</code></pre></div>      </div>

    </div>
  </div>
</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">optimizer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Nadam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">mean_squared_error</span>

<span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">n_steps_per_epoch</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span>
<span class="n">total_steps</span> <span class="o">=</span> <span class="n">n_epochs</span> <span class="o">*</span> <span class="n">n_steps_per_epoch</span>
<span class="n">global_step</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span> <span class="ow">in</span> <span class="n">train_set</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">total_steps</span><span class="p">):</span>
    <span class="n">global_step</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\r</span><span class="s">Global step {}/{}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">global_step</span><span class="p">,</span> <span class="n">total_steps</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s">""</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X_batch</span><span class="p">)</span>
        <span class="n">main_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">y_batch</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">([</span><span class="n">main_loss</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">losses</span><span class="p">)</span>
    <span class="n">gradients</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">)</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">))</span>

</code></pre></div>    </div>
  </div>

  <div class="output_wrapper">
    <div class="output_subarea">
      <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Global step 1810/1810```
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;



&lt;div markdown="1" class="cell code_cell"&gt;
&lt;div class="input_area" markdown="1"&gt;
```python
optimizer = keras.optimizers.Nadam(lr=0.01)
loss_fn = keras.losses.mean_squared_error

@tf.function
def train(model, n_epochs, batch_size=32,
          n_readers=5, n_read_threads=5, shuffle_buffer_size=10000, n_parse_threads=5):
    train_set = csv_reader_dataset(train_filepaths, repeat=n_epochs, n_readers=n_readers,
                       n_read_threads=n_read_threads, shuffle_buffer_size=shuffle_buffer_size,
                       n_parse_threads=n_parse_threads, batch_size=batch_size)
    for X_batch, y_batch in train_set:
        with tf.GradientTape() as tape:
            y_pred = model(X_batch)
            main_loss = tf.reduce_mean(loss_fn(y_batch, y_pred))
            loss = tf.add_n([main_loss] + model.losses)
        gradients = tape.gradient(loss, model.trainable_variables)
        optimizer.apply_gradients(zip(gradients, model.trainable_variables))

train(model, 5)

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">optimizer</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Nadam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">mean_squared_error</span>

<span class="o">@</span><span class="n">tf</span><span class="o">.</span><span class="n">function</span>
<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">n_epochs</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
          <span class="n">n_readers</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_read_threads</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle_buffer_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">n_parse_threads</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">train_set</span> <span class="o">=</span> <span class="n">csv_reader_dataset</span><span class="p">(</span><span class="n">train_filepaths</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">n_epochs</span><span class="p">,</span> <span class="n">n_readers</span><span class="o">=</span><span class="n">n_readers</span><span class="p">,</span>
                       <span class="n">n_read_threads</span><span class="o">=</span><span class="n">n_read_threads</span><span class="p">,</span> <span class="n">shuffle_buffer_size</span><span class="o">=</span><span class="n">shuffle_buffer_size</span><span class="p">,</span>
                       <span class="n">n_parse_threads</span><span class="o">=</span><span class="n">n_parse_threads</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="n">n_steps_per_epoch</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span>
    <span class="n">total_steps</span> <span class="o">=</span> <span class="n">n_epochs</span> <span class="o">*</span> <span class="n">n_steps_per_epoch</span>
    <span class="n">global_step</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span> <span class="ow">in</span> <span class="n">train_set</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">total_steps</span><span class="p">):</span>
        <span class="n">global_step</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">tf</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">global_step</span> <span class="o">%</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">tf</span><span class="o">.</span><span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\r</span><span class="s">Global step"</span><span class="p">,</span> <span class="n">global_step</span><span class="p">,</span> <span class="s">"/"</span><span class="p">,</span> <span class="n">total_steps</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X_batch</span><span class="p">)</span>
            <span class="n">main_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">y_batch</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">([</span><span class="n">main_loss</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">losses</span><span class="p">)</span>
        <span class="n">gradients</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">)</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">))</span>

<span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">
        <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Global step 100 / 1810
Global step 200 / 1810
Global step 300 / 1810
Global step 400 / 1810
Global step 500 / 1810
Global step 600 / 1810
Global step 700 / 1810
Global step 800 / 1810
Global step 900 / 1810
Global step 1000 / 1810
Global step 1100 / 1810
Global step 1200 / 1810
Global step 1300 / 1810
Global step 1400 / 1810
Global step 1500 / 1810
Global step 1600 / 1810
Global step 1700 / 1810
Global step 1800 / 1810
</code></pre></div>        </div>
      </div>
    </div>
  </div>

  <p>Here is a short description of each method in the <code class="language-plaintext highlighter-rouge">Dataset</code> class:</p>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">"_"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">m</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">"_"</span><span class="p">)):</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s">"__doc__"</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"● {:21s}{}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="s">"()"</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">__doc__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">
        <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>● apply()              Applies a transformation function to this dataset.
● batch()              Combines consecutive elements of this dataset into batches.
● cache()              Caches the elements in this dataset.
● concatenate()        Creates a `Dataset` by concatenating given dataset with this dataset.
● filter()             Filters this dataset according to `predicate`.
● flat_map()           Maps `map_func` across this dataset and flattens the result.
● from_generator()     Creates a `Dataset` whose elements are generated by `generator`.
● from_tensor_slices() Creates a `Dataset` whose elements are slices of the given tensors.
● from_tensors()       Creates a `Dataset` with a single element, comprising the given tensors.
● interleave()         Maps `map_func` across this dataset, and interleaves the results.
● list_files()         A dataset of all files matching one or more glob patterns.
● map()                Maps `map_func` across the elements of this dataset.
● options()            Returns the options for this dataset and its inputs.
● padded_batch()       Combines consecutive elements of this dataset into padded batches.
● prefetch()           Creates a `Dataset` that prefetches elements from this dataset.
● range()              Creates a `Dataset` of a step-separated range of values.
● reduce()             Reduces the input dataset to a single element.
● repeat()             Repeats this dataset `count` times.
● shard()              Creates a `Dataset` that includes only 1/`num_shards` of this dataset.
● shuffle()            Randomly shuffles the elements of this dataset.
● skip()               Creates a `Dataset` that skips `count` elements from this dataset.
● take()               Creates a `Dataset` with at most `count` elements from this dataset.
● window()             Combines input elements into a dataset of windows.
● with_options()       Returns a new `tf.data.Dataset` with the given options set.
● zip()                Creates a `Dataset` by zipping together the given datasets.
</code></pre></div>        </div>
      </div>
    </div>
  </div>

  <h2 id="the-tfrecord-binary-format">The <code class="language-plaintext highlighter-rouge">TFRecord</code> binary format</h2>

  <p>A TFRecord file is just a list of binary records. You can create one using a <code class="language-plaintext highlighter-rouge">tf.io.TFRecordWriter</code>:</p>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">TFRecordWriter</span><span class="p">(</span><span class="s">"my_data.tfrecord"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">"This is the first record"</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">"And this is the second record"</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

  </div>

  <p>And you can read it using a <code class="language-plaintext highlighter-rouge">tf.data.TFRecordDataset</code>:</p>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">filepaths</span> <span class="o">=</span> <span class="p">[</span><span class="s">"my_data.tfrecord"</span><span class="p">]</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">(</span><span class="n">filepaths</span><span class="p">)</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">
        <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tf.Tensor(b'This is the first record', shape=(), dtype=string)
tf.Tensor(b'And this is the second record', shape=(), dtype=string)
</code></pre></div>        </div>
      </div>
    </div>
  </div>

  <p>You can read multiple TFRecord files with just one <code class="language-plaintext highlighter-rouge">TFRecordDataset</code>. By default it will read them one at a time, but if you set <code class="language-plaintext highlighter-rouge">num_parallel_reads=3</code>, it will read 3 at a time in parallel and interleave their records:</p>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">filepaths</span> <span class="o">=</span> <span class="p">[</span><span class="s">"my_test_{}.tfrecord"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filepaths</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">TFRecordWriter</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"File {} record {}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">))</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">(</span><span class="n">filepaths</span><span class="p">,</span> <span class="n">num_parallel_reads</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">
        <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tf.Tensor(b'File 0 record 0', shape=(), dtype=string)
tf.Tensor(b'File 1 record 0', shape=(), dtype=string)
tf.Tensor(b'File 2 record 0', shape=(), dtype=string)
tf.Tensor(b'File 0 record 1', shape=(), dtype=string)
tf.Tensor(b'File 1 record 1', shape=(), dtype=string)
tf.Tensor(b'File 2 record 1', shape=(), dtype=string)
tf.Tensor(b'File 0 record 2', shape=(), dtype=string)
tf.Tensor(b'File 1 record 2', shape=(), dtype=string)
tf.Tensor(b'File 2 record 2', shape=(), dtype=string)
tf.Tensor(b'File 3 record 0', shape=(), dtype=string)
tf.Tensor(b'File 4 record 0', shape=(), dtype=string)
tf.Tensor(b'File 3 record 1', shape=(), dtype=string)
tf.Tensor(b'File 4 record 1', shape=(), dtype=string)
tf.Tensor(b'File 3 record 2', shape=(), dtype=string)
tf.Tensor(b'File 4 record 2', shape=(), dtype=string)
</code></pre></div>        </div>
      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">options</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">TFRecordOptions</span><span class="p">(</span><span class="n">compression_type</span><span class="o">=</span><span class="s">"GZIP"</span><span class="p">)</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">TFRecordWriter</span><span class="p">(</span><span class="s">"my_compressed.tfrecord"</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">"This is the first record"</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">"And this is the second record"</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">([</span><span class="s">"my_compressed.tfrecord"</span><span class="p">],</span>
                                  <span class="n">compression_type</span><span class="o">=</span><span class="s">"GZIP"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">
        <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tf.Tensor(b'This is the first record', shape=(), dtype=string)
tf.Tensor(b'And this is the second record', shape=(), dtype=string)
</code></pre></div>        </div>
      </div>
    </div>
  </div>

  <h3 id="a-brief-intro-to-protocol-buffers">A Brief Intro to Protocol Buffers</h3>

  <p>For this section you need to <a href="https://developers.google.com/protocol-buffers/docs/downloads">install protobuf</a>. In general you will not have to do so when using TensorFlow, as it comes with functions to create and parse protocol buffers of type <code class="language-plaintext highlighter-rouge">tf.train.Example</code>, which are generally sufficient. However, in this section we will learn about protocol buffers by creating our own simple protobuf definition, so we need the protobuf compiler (<code class="language-plaintext highlighter-rouge">protoc</code>): we will use it to compile the protobuf definition to a Python module that we can then use in our code.</p>

  <p>First let’s write a simple protobuf definition:</p>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">writefile</span> <span class="n">person</span><span class="o">.</span><span class="n">proto</span>
<span class="n">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>
<span class="n">message</span> <span class="n">Person</span> <span class="p">{</span>
  <span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">int32</span> <span class="nb">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="n">repeated</span> <span class="n">string</span> <span class="n">email</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">
        <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Overwriting person.proto
</code></pre></div>        </div>
      </div>
    </div>
  </div>

  <p>And let’s compile it (the <code class="language-plaintext highlighter-rouge">--descriptor_set_out</code> and <code class="language-plaintext highlighter-rouge">--include_imports</code> options are only required for the <code class="language-plaintext highlighter-rouge">tf.io.decode_proto()</code> example below):</p>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">!</span><span class="n">protoc</span> <span class="n">person</span><span class="o">.</span><span class="n">proto</span> <span class="o">--</span><span class="n">python_out</span><span class="o">=.</span> <span class="o">--</span><span class="n">descriptor_set_out</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">desc</span> <span class="o">--</span><span class="n">include_imports</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">!</span><span class="n">ls</span> <span class="n">person</span><span class="o">*</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">
        <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>person.desc   person.proto  person_pb2.py
</code></pre></div>        </div>
      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">person_pb2</span> <span class="kn">import</span> <span class="n">Person</span>

<span class="n">person</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Al"</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="p">[</span><span class="s">"a@b.com"</span><span class="p">])</span>  <span class="c1"># create a Person
</span><span class="k">print</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>  <span class="c1"># display the Person
</span>
</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">
        <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>name: "Al"
id: 123
email: "a@b.com"

</code></pre></div>        </div>
      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">person</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># read a field
</span>
</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'Al'
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Alice"</span>  <span class="c1"># modify a field
</span>
</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">person</span><span class="o">.</span><span class="n">email</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># repeated fields can be accessed like arrays
</span>
</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'a@b.com'
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">person</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">"c@d.com"</span><span class="p">)</span>  <span class="c1"># add an email address
</span>
</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">s</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span>  <span class="c1"># serialize to a byte string
</span><span class="n">s</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>b'\n\x05Alice\x10{\x1a\x07a@b.com\x1a\x07c@d.com'
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">person2</span> <span class="o">=</span> <span class="n">Person</span><span class="p">()</span>  <span class="c1"># create a new Person
</span><span class="n">person2</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># parse the byte string (27 bytes)
</span>
</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>27
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">person</span> <span class="o">==</span> <span class="n">person2</span>  <span class="c1"># now they are equal
</span>
</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>True
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <h4 id="custom-protobuf">Custom protobuf</h4>

  <p>In rare cases, you may want to parse a custom protobuf (like the one we just created) in TensorFlow. For this you can use the <code class="language-plaintext highlighter-rouge">tf.io.decode_proto()</code> function:</p>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">person_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">decode_proto</span><span class="p">(</span>
    <span class="nb">bytes</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
    <span class="n">message_type</span><span class="o">=</span><span class="s">"Person"</span><span class="p">,</span>
    <span class="n">field_names</span><span class="o">=</span><span class="p">[</span><span class="s">"name"</span><span class="p">,</span> <span class="s">"id"</span><span class="p">,</span> <span class="s">"email"</span><span class="p">],</span>
    <span class="n">output_types</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">],</span>
    <span class="n">descriptor_source</span><span class="o">=</span><span class="s">"person.desc"</span><span class="p">)</span>

<span class="n">person_tf</span><span class="o">.</span><span class="n">values</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[&lt;tf.Tensor: id=12, shape=(1,), dtype=string, numpy=array([b'Alice'], dtype=object)&gt;,
 &lt;tf.Tensor: id=13, shape=(1,), dtype=int32, numpy=array([123], dtype=int32)&gt;,
 &lt;tf.Tensor: id=14, shape=(2,), dtype=string, numpy=array([b'a@b.com', b'c@d.com'], dtype=object)&gt;]
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <p>For more details, see the <a href="https://www.tensorflow.org/api_docs/python/tf/io/decode_proto"><code class="language-plaintext highlighter-rouge">tf.io.decode_proto()</code></a> documentation.</p>

  <h3 id="tensorflow-protobufs">TensorFlow Protobufs</h3>

  <p>Here is the definition of the tf.train.Example protobuf:</p>

  <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="kd">message</span> <span class="nc">BytesList</span> <span class="p">{</span> <span class="k">repeated</span> <span class="kt">bytes</span> <span class="na">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
<span class="kd">message</span> <span class="nc">FloatList</span> <span class="p">{</span> <span class="k">repeated</span> <span class="kt">float</span> <span class="na">value</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">[</span><span class="k">packed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">];</span> <span class="p">}</span>
<span class="kd">message</span> <span class="nc">Int64List</span> <span class="p">{</span> <span class="k">repeated</span> <span class="kt">int64</span> <span class="na">value</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">[</span><span class="k">packed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">];</span> <span class="p">}</span>
<span class="kd">message</span> <span class="nc">Feature</span> <span class="p">{</span>
    <span class="k">oneof</span> <span class="n">kind</span> <span class="p">{</span>
        <span class="n">BytesList</span> <span class="na">bytes_list</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">FloatList</span> <span class="na">float_list</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">Int64List</span> <span class="na">int64_list</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="kd">message</span> <span class="nc">Features</span> <span class="p">{</span> <span class="n">map</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">Feature</span><span class="err">&gt;</span> <span class="na">feature</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">};</span>
<span class="kd">message</span> <span class="nc">Example</span> <span class="p">{</span> <span class="n">Features</span> <span class="na">features</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">};</span>
</code></pre></div>  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># WARNING: there's currently a bug preventing "from tensorflow.train import X"
#          so we work around it by writing "X = tf.train.X"
#from tensorflow.train import BytesList, FloatList, Int64List
#from tensorflow.train import Feature, Features, Example
</span><span class="n">BytesList</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">BytesList</span>
<span class="n">FloatList</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">FloatList</span>
<span class="n">Int64List</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Int64List</span>
<span class="n">Feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span>
<span class="n">Features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Features</span>
<span class="n">Example</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Example</span>

<span class="n">person_example</span> <span class="o">=</span> <span class="n">Example</span><span class="p">(</span>
    <span class="n">features</span><span class="o">=</span><span class="n">Features</span><span class="p">(</span>
        <span class="n">feature</span><span class="o">=</span><span class="p">{</span>
            <span class="s">"name"</span><span class="p">:</span> <span class="n">Feature</span><span class="p">(</span><span class="n">bytes_list</span><span class="o">=</span><span class="n">BytesList</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">b</span><span class="s">"Alice"</span><span class="p">])),</span>
            <span class="s">"id"</span><span class="p">:</span> <span class="n">Feature</span><span class="p">(</span><span class="n">int64_list</span><span class="o">=</span><span class="n">Int64List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">123</span><span class="p">])),</span>
            <span class="s">"emails"</span><span class="p">:</span> <span class="n">Feature</span><span class="p">(</span><span class="n">bytes_list</span><span class="o">=</span><span class="n">BytesList</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">b</span><span class="s">"a@b.com"</span><span class="p">,</span> <span class="n">b</span><span class="s">"c@d.com"</span><span class="p">]))</span>
        <span class="p">}))</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">TFRecordWriter</span><span class="p">(</span><span class="s">"my_contacts.tfrecord"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">person_example</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">feature_description</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"name"</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="s">""</span><span class="p">),</span>
    <span class="s">"id"</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="s">"emails"</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
<span class="p">}</span>
<span class="k">for</span> <span class="n">serialized_example</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">([</span><span class="s">"my_contacts.tfrecord"</span><span class="p">]):</span>
    <span class="n">parsed_example</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_single_example</span><span class="p">(</span><span class="n">serialized_example</span><span class="p">,</span>
                                                <span class="n">feature_description</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parsed_example</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{'emails': &lt;tensorflow.python.framework.sparse_tensor.SparseTensor at 0x102a2acc0&gt;,
 'id': &lt;tf.Tensor: id=535953, shape=(), dtype=int64, numpy=123&gt;,
 'name': &lt;tf.Tensor: id=535954, shape=(), dtype=string, numpy=b'Alice'&gt;}
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parsed_example</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{'emails': &lt;tensorflow.python.framework.sparse_tensor.SparseTensor at 0x102a2acc0&gt;,
 'id': &lt;tf.Tensor: id=535953, shape=(), dtype=int64, numpy=123&gt;,
 'name': &lt;tf.Tensor: id=535954, shape=(), dtype=string, numpy=b'Alice'&gt;}
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parsed_example</span><span class="p">[</span><span class="s">"emails"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;tf.Tensor: id=535962, shape=(), dtype=string, numpy=b'a@b.com'&gt;
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">to_dense</span><span class="p">(</span><span class="n">parsed_example</span><span class="p">[</span><span class="s">"emails"</span><span class="p">],</span> <span class="n">default_value</span><span class="o">=</span><span class="n">b</span><span class="s">""</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;tf.Tensor: id=535965, shape=(2,), dtype=string, numpy=array([b'a@b.com', b'c@d.com'], dtype=object)&gt;
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parsed_example</span><span class="p">[</span><span class="s">"emails"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;tf.Tensor: id=535951, shape=(2,), dtype=string, numpy=array([b'a@b.com', b'c@d.com'], dtype=object)&gt;
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <h3 id="putting-images-in-tfrecords">Putting Images in TFRecords</h3>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_sample_images</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">load_sample_images</span><span class="p">()[</span><span class="s">"images"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">"off"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Original Image"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <p class="output_png"><img src="../../images/notebooks/24-tensorflow/13_loading_and_preprocessing_data_95_0.png" alt="png" /></p>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">encode_jpeg</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="n">example_with_image</span> <span class="o">=</span> <span class="n">Example</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">Features</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="p">{</span>
    <span class="s">"image"</span><span class="p">:</span> <span class="n">Feature</span><span class="p">(</span><span class="n">bytes_list</span><span class="o">=</span><span class="n">BytesList</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">()]))}))</span>
<span class="n">serialized_example</span> <span class="o">=</span> <span class="n">example_with_image</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span>
<span class="c1"># then save to TFRecord
</span>
</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">feature_description</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"image"</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">)</span> <span class="p">}</span>
<span class="n">example_with_image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_single_example</span><span class="p">(</span><span class="n">serialized_example</span><span class="p">,</span> <span class="n">feature_description</span><span class="p">)</span>
<span class="n">decoded_img</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">decode_jpeg</span><span class="p">(</span><span class="n">example_with_image</span><span class="p">[</span><span class="s">"image"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

</code></pre></div>      </div>
    </div>

  </div>

  <p>Or use <code class="language-plaintext highlighter-rouge">decode_image()</code> which supports BMP, GIF, JPEG and PNG formats:</p>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">decoded_img</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">decode_image</span><span class="p">(</span><span class="n">example_with_image</span><span class="p">[</span><span class="s">"image"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">decoded_img</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Decoded Image"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">"off"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <p class="output_png"><img src="../../images/notebooks/24-tensorflow/13_loading_and_preprocessing_data_100_0.png" alt="png" /></p>

      </div>
    </div>
  </div>

  <h3 id="putting-tensors-and-sparse-tensors-in-tfrecords">Putting Tensors and Sparse Tensors in TFRecords</h3>

  <p>Tensors can be serialized and parsed easily using <code class="language-plaintext highlighter-rouge">tf.io.serialize_tensor()</code> and <code class="language-plaintext highlighter-rouge">tf.io.parse_tensor()</code>:</p>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">t</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">],</span> <span class="p">[</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">]])</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">serialize_tensor</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="n">s</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;tf.Tensor: id=536000, shape=(), dtype=string, numpy=b'\x08\x01\x12\x08\x12\x02\x08\x03\x12\x02\x08\x02"\x18\x00\x00\x00\x00\x00\x00\x80?\x00\x00\x00@\x00\x00@@\x00\x00\x80@\x00\x00\xa0@'&gt;
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_tensor</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">out_type</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;tf.Tensor: id=536002, shape=(3, 2), dtype=float32, numpy=
array([[0., 1.],
       [2., 3.],
       [4., 5.]], dtype=float32)&gt;
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">serialized_sparse</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">serialize_sparse</span><span class="p">(</span><span class="n">parsed_example</span><span class="p">[</span><span class="s">"emails"</span><span class="p">])</span>
<span class="n">serialized_sparse</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;tf.Tensor: id=536004, shape=(3,), dtype=string, numpy=
array([b'\x08\t\x12\x08\x12\x02\x08\x02\x12\x02\x08\x01"\x10\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00',
       b'\x08\x07\x12\x04\x12\x02\x08\x02"\x10\x07\x07a@b.comc@d.com',
       b'\x08\t\x12\x04\x12\x02\x08\x01"\x08\x02\x00\x00\x00\x00\x00\x00\x00'],
      dtype=object)&gt;
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BytesList</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">serialized_sparse</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>value: "\010\t\022\010\022\002\010\002\022\002\010\001\"\020\000\000\000\000\000\000\000\000\001\000\000\000\000\000\000\000"
value: "\010\007\022\004\022\002\010\002\"\020\007\007a@b.comc@d.com"
value: "\010\t\022\004\022\002\010\001\"\010\002\000\000\000\000\000\000\000"
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">([</span><span class="s">"my_contacts.tfrecord"</span><span class="p">])</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="k">for</span> <span class="n">serialized_examples</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
    <span class="n">parsed_examples</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_example</span><span class="p">(</span><span class="n">serialized_examples</span><span class="p">,</span>
                                          <span class="n">feature_description</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parsed_examples</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{'image': &lt;tensorflow.python.framework.sparse_tensor.SparseTensor at 0x129697b70&gt;}
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <h2 id="handling-sequential-data-using-sequenceexample">Handling Sequential Data Using <code class="language-plaintext highlighter-rouge">SequenceExample</code></h2>

  <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="kd">message</span> <span class="nc">FeatureList</span> <span class="p">{</span> <span class="k">repeated</span> <span class="n">Feature</span> <span class="na">feature</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">};</span>
<span class="kd">message</span> <span class="nc">FeatureLists</span> <span class="p">{</span> <span class="n">map</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">FeatureList</span><span class="err">&gt;</span> <span class="na">feature_list</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">};</span>
<span class="kd">message</span> <span class="nc">SequenceExample</span> <span class="p">{</span>
  <span class="n">Features</span> <span class="na">context</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">FeatureLists</span> <span class="na">feature_lists</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># WARNING: there's currently a bug preventing "from tensorflow.train import X"
#          so we work around it by writing "X = tf.train.X"
#from tensorflow.train import FeatureList, FeatureLists, SequenceExample
</span><span class="n">FeatureList</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">FeatureList</span>
<span class="n">FeatureLists</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">FeatureLists</span>
<span class="n">SequenceExample</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">SequenceExample</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">Features</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="p">{</span>
    <span class="s">"author_id"</span><span class="p">:</span> <span class="n">Feature</span><span class="p">(</span><span class="n">int64_list</span><span class="o">=</span><span class="n">Int64List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">123</span><span class="p">])),</span>
    <span class="s">"title"</span><span class="p">:</span> <span class="n">Feature</span><span class="p">(</span><span class="n">bytes_list</span><span class="o">=</span><span class="n">BytesList</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">b</span><span class="s">"A"</span><span class="p">,</span> <span class="n">b</span><span class="s">"desert"</span><span class="p">,</span> <span class="n">b</span><span class="s">"place"</span><span class="p">,</span> <span class="n">b</span><span class="s">"."</span><span class="p">])),</span>
    <span class="s">"pub_date"</span><span class="p">:</span> <span class="n">Feature</span><span class="p">(</span><span class="n">int64_list</span><span class="o">=</span><span class="n">Int64List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">1623</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">25</span><span class="p">]))</span>
<span class="p">})</span>

<span class="n">content</span> <span class="o">=</span> <span class="p">[[</span><span class="s">"When"</span><span class="p">,</span> <span class="s">"shall"</span><span class="p">,</span> <span class="s">"we"</span><span class="p">,</span> <span class="s">"three"</span><span class="p">,</span> <span class="s">"meet"</span><span class="p">,</span> <span class="s">"again"</span><span class="p">,</span> <span class="s">"?"</span><span class="p">],</span>
           <span class="p">[</span><span class="s">"In"</span><span class="p">,</span> <span class="s">"thunder"</span><span class="p">,</span> <span class="s">","</span><span class="p">,</span> <span class="s">"lightning"</span><span class="p">,</span> <span class="s">","</span><span class="p">,</span> <span class="s">"or"</span><span class="p">,</span> <span class="s">"in"</span><span class="p">,</span> <span class="s">"rain"</span><span class="p">,</span> <span class="s">"?"</span><span class="p">]]</span>
<span class="n">comments</span> <span class="o">=</span> <span class="p">[[</span><span class="s">"When"</span><span class="p">,</span> <span class="s">"the"</span><span class="p">,</span> <span class="s">"hurlyburly"</span><span class="p">,</span> <span class="s">"'s"</span><span class="p">,</span> <span class="s">"done"</span><span class="p">,</span> <span class="s">"."</span><span class="p">],</span>
            <span class="p">[</span><span class="s">"When"</span><span class="p">,</span> <span class="s">"the"</span><span class="p">,</span> <span class="s">"battle"</span><span class="p">,</span> <span class="s">"'s"</span><span class="p">,</span> <span class="s">"lost"</span><span class="p">,</span> <span class="s">"and"</span><span class="p">,</span> <span class="s">"won"</span><span class="p">,</span> <span class="s">"."</span><span class="p">]]</span>

<span class="k">def</span> <span class="nf">words_to_feature</span><span class="p">(</span><span class="n">words</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Feature</span><span class="p">(</span><span class="n">bytes_list</span><span class="o">=</span><span class="n">BytesList</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">word</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)</span>
                                               <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]))</span>

<span class="n">content_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">words_to_feature</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span> <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">content</span><span class="p">]</span>
<span class="n">comments_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">words_to_feature</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span> <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">comments</span><span class="p">]</span>
            
<span class="n">sequence_example</span> <span class="o">=</span> <span class="n">SequenceExample</span><span class="p">(</span>
    <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
    <span class="n">feature_lists</span><span class="o">=</span><span class="n">FeatureLists</span><span class="p">(</span><span class="n">feature_list</span><span class="o">=</span><span class="p">{</span>
        <span class="s">"content"</span><span class="p">:</span> <span class="n">FeatureList</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">content_features</span><span class="p">),</span>
        <span class="s">"comments"</span><span class="p">:</span> <span class="n">FeatureList</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">comments_features</span><span class="p">)</span>
    <span class="p">}))</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sequence_example</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>context {
  feature {
    key: "author_id"
    value {
      int64_list {
        value: 123
      }
    }
  }
  feature {
    key: "pub_date"
    value {
      int64_list {
        value: 1623
        value: 12
        value: 25
      }
    }
  }
  feature {
    key: "title"
    value {
      bytes_list {
        value: "A"
        value: "desert"
        value: "place"
        value: "."
      }
    }
  }
}
feature_lists {
  feature_list {
    key: "comments"
    value {
      feature {
        bytes_list {
          value: "When"
          value: "the"
          value: "hurlyburly"
          value: "\'s"
          value: "done"
          value: "."
        }
      }
      feature {
        bytes_list {
          value: "When"
          value: "the"
          value: "battle"
          value: "\'s"
          value: "lost"
          value: "and"
          value: "won"
          value: "."
        }
      }
    }
  }
  feature_list {
    key: "content"
    value {
      feature {
        bytes_list {
          value: "When"
          value: "shall"
          value: "we"
          value: "three"
          value: "meet"
          value: "again"
          value: "?"
        }
      }
      feature {
        bytes_list {
          value: "In"
          value: "thunder"
          value: ","
          value: "lightning"
          value: ","
          value: "or"
          value: "in"
          value: "rain"
          value: "?"
        }
      }
    }
  }
}
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">serialized_sequence_example</span> <span class="o">=</span> <span class="n">sequence_example</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">context_feature_descriptions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"author_id"</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="s">"title"</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
    <span class="s">"pub_date"</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([</span><span class="mi">3</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
<span class="p">}</span>
<span class="n">sequence_feature_descriptions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"content"</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
    <span class="s">"comments"</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
<span class="p">}</span>
<span class="n">parsed_context</span><span class="p">,</span> <span class="n">parsed_feature_lists</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_single_sequence_example</span><span class="p">(</span>
    <span class="n">serialized_sequence_example</span><span class="p">,</span> <span class="n">context_feature_descriptions</span><span class="p">,</span>
    <span class="n">sequence_feature_descriptions</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parsed_context</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{'title': &lt;tensorflow.python.framework.sparse_tensor.SparseTensor at 0x134ff6c88&gt;,
 'author_id': &lt;tf.Tensor: id=536050, shape=(), dtype=int64, numpy=123&gt;,
 'pub_date': &lt;tf.Tensor: id=536051, shape=(3,), dtype=int64, numpy=array([1623,   12,   25])&gt;}
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parsed_context</span><span class="p">[</span><span class="s">"title"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;tf.Tensor: id=536048, shape=(4,), dtype=string, numpy=array([b'A', b'desert', b'place', b'.'], dtype=object)&gt;
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parsed_feature_lists</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{'comments': &lt;tensorflow.python.framework.sparse_tensor.SparseTensor at 0x134ff6f98&gt;,
 'content': &lt;tensorflow.python.framework.sparse_tensor.SparseTensor at 0x130e23390&gt;}
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">RaggedTensor</span><span class="o">.</span><span class="n">from_sparse</span><span class="p">(</span><span class="n">parsed_feature_lists</span><span class="p">[</span><span class="s">"content"</span><span class="p">]))</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">
        <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;tf.RaggedTensor [[b'When', b'shall', b'we', b'three', b'meet', b'again', b'?'], [b'In', b'thunder', b',', b'lightning', b',', b'or', b'in', b'rain', b'?']]&gt;
</code></pre></div>        </div>
      </div>
    </div>
  </div>

  <h1 id="the-features-api">The Features API</h1>

  <p>Let’s use the variant of the California housing dataset that we used in Chapter 2, since it contains categorical features and missing values:</p>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">urllib</span>

<span class="n">DOWNLOAD_ROOT</span> <span class="o">=</span> <span class="s">"https://raw.githubusercontent.com/ageron/handson-ml2/master/"</span>
<span class="n">HOUSING_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">"datasets"</span><span class="p">,</span> <span class="s">"housing"</span><span class="p">)</span>
<span class="n">HOUSING_URL</span> <span class="o">=</span> <span class="n">DOWNLOAD_ROOT</span> <span class="o">+</span> <span class="s">"datasets/housing/housing.tgz"</span>

<span class="k">def</span> <span class="nf">fetch_housing_data</span><span class="p">(</span><span class="n">housing_url</span><span class="o">=</span><span class="n">HOUSING_URL</span><span class="p">,</span> <span class="n">housing_path</span><span class="o">=</span><span class="n">HOUSING_PATH</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">housing_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">tgz_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">housing_path</span><span class="p">,</span> <span class="s">"housing.tgz"</span><span class="p">)</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">housing_url</span><span class="p">,</span> <span class="n">tgz_path</span><span class="p">)</span>
    <span class="n">housing_tgz</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">tgz_path</span><span class="p">)</span>
    <span class="n">housing_tgz</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">housing_path</span><span class="p">)</span>
    <span class="n">housing_tgz</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fetch_housing_data</span><span class="p">()</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="k">def</span> <span class="nf">load_housing_data</span><span class="p">(</span><span class="n">housing_path</span><span class="o">=</span><span class="n">HOUSING_PATH</span><span class="p">):</span>
    <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">housing_path</span><span class="p">,</span> <span class="s">"housing.csv"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">housing</span> <span class="o">=</span> <span class="n">load_housing_data</span><span class="p">()</span>
<span class="n">housing</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="output output_html">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>longitude</th>
      <th>latitude</th>
      <th>housing_median_age</th>
      <th>total_rooms</th>
      <th>total_bedrooms</th>
      <th>population</th>
      <th>households</th>
      <th>median_income</th>
      <th>median_house_value</th>
      <th>ocean_proximity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-122.23</td>
      <td>37.88</td>
      <td>41.0</td>
      <td>880.0</td>
      <td>129.0</td>
      <td>322.0</td>
      <td>126.0</td>
      <td>8.3252</td>
      <td>452600.0</td>
      <td>NEAR BAY</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-122.22</td>
      <td>37.86</td>
      <td>21.0</td>
      <td>7099.0</td>
      <td>1106.0</td>
      <td>2401.0</td>
      <td>1138.0</td>
      <td>8.3014</td>
      <td>358500.0</td>
      <td>NEAR BAY</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-122.24</td>
      <td>37.85</td>
      <td>52.0</td>
      <td>1467.0</td>
      <td>190.0</td>
      <td>496.0</td>
      <td>177.0</td>
      <td>7.2574</td>
      <td>352100.0</td>
      <td>NEAR BAY</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-122.25</td>
      <td>37.85</td>
      <td>52.0</td>
      <td>1274.0</td>
      <td>235.0</td>
      <td>558.0</td>
      <td>219.0</td>
      <td>5.6431</td>
      <td>341300.0</td>
      <td>NEAR BAY</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-122.25</td>
      <td>37.85</td>
      <td>52.0</td>
      <td>1627.0</td>
      <td>280.0</td>
      <td>565.0</td>
      <td>259.0</td>
      <td>3.8462</td>
      <td>342200.0</td>
      <td>NEAR BAY</td>
    </tr>
  </tbody>
</table>
</div>
</div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">housing_median_age</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">numeric_column</span><span class="p">(</span><span class="s">"housing_median_age"</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">age_mean</span><span class="p">,</span> <span class="n">age_std</span> <span class="o">=</span> <span class="n">X_mean</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">X_std</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># The median age is column in 1
</span><span class="n">housing_median_age</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">numeric_column</span><span class="p">(</span>
    <span class="s">"housing_median_age"</span><span class="p">,</span> <span class="n">normalizer_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">age_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">age_std</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">median_income</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">numeric_column</span><span class="p">(</span><span class="s">"median_income"</span><span class="p">)</span>
<span class="n">bucketized_income</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">bucketized_column</span><span class="p">(</span>
    <span class="n">median_income</span><span class="p">,</span> <span class="n">boundaries</span><span class="o">=</span><span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">6.</span><span class="p">])</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bucketized_income</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BucketizedColumn(source_column=NumericColumn(key='median_income', shape=(1,), default_value=None, dtype=tf.float32, normalizer_fn=None), boundaries=(1.5, 3.0, 4.5, 6.0))
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ocean_prox_vocab</span> <span class="o">=</span> <span class="p">[</span><span class="s">'&lt;1H OCEAN'</span><span class="p">,</span> <span class="s">'INLAND'</span><span class="p">,</span> <span class="s">'ISLAND'</span><span class="p">,</span> <span class="s">'NEAR BAY'</span><span class="p">,</span> <span class="s">'NEAR OCEAN'</span><span class="p">]</span>
<span class="n">ocean_proximity</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">categorical_column_with_vocabulary_list</span><span class="p">(</span>
    <span class="s">"ocean_proximity"</span><span class="p">,</span> <span class="n">ocean_prox_vocab</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ocean_proximity</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>VocabularyListCategoricalColumn(key='ocean_proximity', vocabulary_list=('&lt;1H OCEAN', 'INLAND', 'ISLAND', 'NEAR BAY', 'NEAR OCEAN'), dtype=tf.string, default_value=-1, num_oov_buckets=0)
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Just an example, it's not used later on
</span><span class="n">city_hash</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">categorical_column_with_hash_bucket</span><span class="p">(</span>
    <span class="s">"city"</span><span class="p">,</span> <span class="n">hash_bucket_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">city_hash</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HashedCategoricalColumn(key='city', hash_bucket_size=1000, dtype=tf.string)
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bucketized_age</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">bucketized_column</span><span class="p">(</span>
    <span class="n">housing_median_age</span><span class="p">,</span> <span class="n">boundaries</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span> <span class="c1"># age was scaled
</span><span class="n">age_and_ocean_proximity</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">crossed_column</span><span class="p">(</span>
    <span class="p">[</span><span class="n">bucketized_age</span><span class="p">,</span> <span class="n">ocean_proximity</span><span class="p">],</span> <span class="n">hash_bucket_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">latitude</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">numeric_column</span><span class="p">(</span><span class="s">"latitude"</span><span class="p">)</span>
<span class="n">longitude</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">numeric_column</span><span class="p">(</span><span class="s">"longitude"</span><span class="p">)</span>
<span class="n">bucketized_latitude</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">bucketized_column</span><span class="p">(</span>
    <span class="n">latitude</span><span class="p">,</span> <span class="n">boundaries</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">32.</span><span class="p">,</span> <span class="mf">42.</span><span class="p">,</span> <span class="mi">20</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
<span class="n">bucketized_longitude</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">bucketized_column</span><span class="p">(</span>
    <span class="n">longitude</span><span class="p">,</span> <span class="n">boundaries</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">125.</span><span class="p">,</span> <span class="o">-</span><span class="mf">114.</span><span class="p">,</span> <span class="mi">20</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
<span class="n">location</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">crossed_column</span><span class="p">(</span>
    <span class="p">[</span><span class="n">bucketized_latitude</span><span class="p">,</span> <span class="n">bucketized_longitude</span><span class="p">],</span> <span class="n">hash_bucket_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ocean_proximity_one_hot</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">indicator_column</span><span class="p">(</span><span class="n">ocean_proximity</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ocean_proximity_embed</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">embedding_column</span><span class="p">(</span><span class="n">ocean_proximity</span><span class="p">,</span>
                                                           <span class="n">dimension</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

  </div>

  <h3 id="using-feature-columns-for-parsing">Using Feature Columns for Parsing</h3>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">median_house_value</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">numeric_column</span><span class="p">(</span><span class="s">"median_house_value"</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">housing_median_age</span><span class="p">,</span> <span class="n">median_house_value</span><span class="p">]</span>
<span class="n">feature_descriptions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">feature_column</span><span class="o">.</span><span class="n">make_parse_example_spec</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
<span class="n">feature_descriptions</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{'housing_median_age': FixedLenFeature(shape=(1,), dtype=tf.float32, default_value=None),
 'median_house_value': FixedLenFeature(shape=(1,), dtype=tf.float32, default_value=None)}
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">TFRecordWriter</span><span class="p">(</span><span class="s">"my_data_with_features.tfrecords"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">X_train</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">y_train</span><span class="p">):</span>
        <span class="n">example</span> <span class="o">=</span> <span class="n">Example</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">Features</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="p">{</span>
            <span class="s">"housing_median_age"</span><span class="p">:</span> <span class="n">Feature</span><span class="p">(</span><span class="n">float_list</span><span class="o">=</span><span class="n">FloatList</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">])),</span>
            <span class="s">"median_house_value"</span><span class="p">:</span> <span class="n">Feature</span><span class="p">(</span><span class="n">float_list</span><span class="o">=</span><span class="n">FloatList</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">y</span><span class="p">]))</span>
        <span class="p">}))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">parse_examples</span><span class="p">(</span><span class="n">serialized_examples</span><span class="p">):</span>
    <span class="n">examples</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_example</span><span class="p">(</span><span class="n">serialized_examples</span><span class="p">,</span> <span class="n">feature_descriptions</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">examples</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">"median_house_value"</span><span class="p">)</span> <span class="c1"># separate the targets
</span>    <span class="k">return</span> <span class="n">examples</span><span class="p">,</span> <span class="n">targets</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">([</span><span class="s">"my_data_with_features.tfrecords"</span><span class="p">])</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">repeat</span><span class="p">()</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">parse_examples</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

  </div>

  <p><strong>Warning</strong>: the <code class="language-plaintext highlighter-rouge">DenseFeatures</code> layer currently does not work with the Functional API, see <a href="https://github.com/tensorflow/tensorflow/issues/27416">TF issue #27416</a>. Hopefully this will be resolved before the final release of TF 2.0.</p>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">columns_without_target</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">DenseFeatures</span><span class="p">(</span><span class="n">feature_columns</span><span class="o">=</span><span class="n">columns_without_target</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s">"mse"</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">"accuracy"</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">steps_per_epoch</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">
        <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Epoch 1/5
362/362 [==============================] - 1s 3ms/step - loss: 5.0263 - accuracy: 0.0017
Epoch 2/5
362/362 [==============================] - 1s 2ms/step - loss: 2.1655 - accuracy: 0.0036
Epoch 3/5
362/362 [==============================] - 1s 2ms/step - loss: 1.5688 - accuracy: 0.0028
Epoch 4/5
362/362 [==============================] - 1s 2ms/step - loss: 1.3550 - accuracy: 0.0022
Epoch 5/5
362/362 [==============================] - 1s 2ms/step - loss: 1.3466 - accuracy: 0.0035
</code></pre></div>        </div>
      </div>
    </div>
    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;tensorflow.python.keras.callbacks.History at 0x134ff5f98&gt;
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">some_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">ocean_proximity_embed</span><span class="p">,</span> <span class="n">bucketized_income</span><span class="p">]</span>
<span class="n">dense_features</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">DenseFeatures</span><span class="p">(</span><span class="n">some_columns</span><span class="p">)</span>
<span class="n">dense_features</span><span class="p">({</span>
    <span class="s">"ocean_proximity"</span><span class="p">:</span> <span class="p">[[</span><span class="s">"NEAR OCEAN"</span><span class="p">],</span> <span class="p">[</span><span class="s">"INLAND"</span><span class="p">],</span> <span class="p">[</span><span class="s">"INLAND"</span><span class="p">]],</span>
    <span class="s">"median_income"</span><span class="p">:</span> <span class="p">[[</span><span class="mf">3.</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.2</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">]]</span>
<span class="p">})</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;tf.Tensor: id=551231, shape=(3, 7), dtype=float32, numpy=
array([[ 0.        ,  0.        ,  1.        ,  0.        ,  0.        ,
         0.30818242, -0.40305588],
       [ 0.        ,  0.        ,  0.        ,  0.        ,  1.        ,
        -0.7438171 ,  0.19444346],
       [ 1.        ,  0.        ,  0.        ,  0.        ,  0.        ,
        -0.7438171 ,  0.19444346]], dtype=float32)&gt;
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <h1 id="tf-transform">TF Transform</h1>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">tensorflow_transform</span> <span class="k">as</span> <span class="n">tft</span>

    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>  <span class="c1"># inputs is a batch of input features
</span>        <span class="n">median_age</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s">"housing_median_age"</span><span class="p">]</span>
        <span class="n">ocean_proximity</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s">"ocean_proximity"</span><span class="p">]</span>
        <span class="n">standardized_age</span> <span class="o">=</span> <span class="n">tft</span><span class="o">.</span><span class="n">scale_to_z_score</span><span class="p">(</span><span class="n">median_age</span> <span class="o">-</span> <span class="n">tft</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">median_age</span><span class="p">))</span>
        <span class="n">ocean_proximity_id</span> <span class="o">=</span> <span class="n">tft</span><span class="o">.</span><span class="n">compute_and_apply_vocabulary</span><span class="p">(</span><span class="n">ocean_proximity</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">"standardized_median_age"</span><span class="p">:</span> <span class="n">standardized_age</span><span class="p">,</span>
            <span class="s">"ocean_proximity_id"</span><span class="p">:</span> <span class="n">ocean_proximity_id</span>
        <span class="p">}</span>
<span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"TF Transform is not installed. Try running: pip3 install -U tensorflow-transform"</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">
        <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TF Transform is not installed. Try running: pip3 install -U tensorflow-transform
</code></pre></div>        </div>
      </div>
    </div>
  </div>

  <h1 id="tensorflow-datasets">TensorFlow Datasets</h1>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="n">tfds</span>

<span class="n">datasets</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"mnist"</span><span class="p">)</span>
<span class="n">mnist_train</span><span class="p">,</span> <span class="n">mnist_test</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="s">"train"</span><span class="p">],</span> <span class="n">datasets</span><span class="p">[</span><span class="s">"test"</span><span class="p">]</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">tfds</span><span class="o">.</span><span class="n">list_builders</span><span class="p">())</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">
        <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>['bair_robot_pushing_small', 'cats_vs_dogs', 'celeb_a', 'celeb_a_hq', 'chexpert', 'cifar10', 'cifar100', 'coco2014', 'colorectal_histology', 'colorectal_histology_large', 'diabetic_retinopathy_detection', 'dummy_dataset_shared_generator', 'dummy_mnist', 'fashion_mnist', 'flores_translate_neen', 'flores_translate_sien', 'horses_or_humans', 'image_label_folder', 'imagenet2012', 'imdb_reviews', 'kmnist', 'lm1b', 'lsun', 'mnist', 'moving_mnist', 'multi_nli', 'nsynth', 'omniglot', 'open_images_v4', 'quickdraw_bitmap', 'rock_paper_scissors', 'squad', 'starcraft_video', 'svhn_cropped', 'ted_hrlr_translate', 'ted_multi_translate', 'tf_flowers', 'titanic', 'wmt_translate_ende', 'wmt_translate_enfr']
</code></pre></div>        </div>
      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">mnist_train</span> <span class="o">=</span> <span class="n">mnist_train</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mnist_train</span><span class="p">:</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s">"image"</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s">"label"</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">"binary"</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">"off"</span><span class="p">)</span>
    <span class="k">break</span> <span class="c1"># just showing part of the first batch
</span>
</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <p class="output_png"><img src="../../images/notebooks/24-tensorflow/13_loading_and_preprocessing_data_149_0.png" alt="png" /></p>

      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">datasets</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"mnist"</span><span class="p">)</span>
<span class="n">mnist_train</span><span class="p">,</span> <span class="n">mnist_test</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="s">"train"</span><span class="p">],</span> <span class="n">datasets</span><span class="p">[</span><span class="s">"test"</span><span class="p">]</span>
<span class="n">mnist_train</span> <span class="o">=</span> <span class="n">mnist_train</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="n">mnist_train</span> <span class="o">=</span> <span class="n">mnist_train</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">items</span><span class="p">:</span> <span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="s">"image"</span><span class="p">],</span> <span class="n">items</span><span class="p">[</span><span class="s">"label"</span><span class="p">]))</span>
<span class="n">mnist_train</span> <span class="o">=</span> <span class="n">mnist_train</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">mnist_train</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">
        <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(32, 28, 28, 1)
[1 3 8 6 0 7 7 9 2 7 3 7 6 0 4 9 8 1 5 6 0 8 0 3 7 2 6 3 3 5 5 4]
</code></pre></div>        </div>
      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">datasets</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"mnist"</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">as_supervised</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">mnist_train</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="s">"train"</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">()</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="k">lambda</span> <span class="n">images</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">"softmax"</span><span class="p">)])</span>
<span class="n">model</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s">"sparse_categorical_crossentropy"</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">"accuracy"</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">mnist_train</span><span class="p">,</span> <span class="n">steps_per_epoch</span><span class="o">=</span><span class="mi">60000</span> <span class="o">//</span> <span class="mi">32</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">
        <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Epoch 1/5
1875/1875 [==============================] - 7s 4ms/step - loss: 31.4932 - accuracy: 0.8428
Epoch 2/5
1875/1875 [==============================] - 7s 4ms/step - loss: 26.2404 - accuracy: 0.8693
Epoch 3/5
1875/1875 [==============================] - 7s 4ms/step - loss: 24.9957 - accuracy: 0.8743
Epoch 4/5
1875/1875 [==============================] - 7s 4ms/step - loss: 24.0785 - accuracy: 0.8780
Epoch 5/5
1875/1875 [==============================] - 7s 4ms/step - loss: 23.8285 - accuracy: 0.8782
</code></pre></div>        </div>
      </div>
    </div>
    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;tensorflow.python.keras.callbacks.History at 0x131dad240&gt;
</code></pre></div>        </div>

      </div>
    </div>
  </div>

  <h1 id="tensorflow-hub">TensorFlow Hub</h1>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">tensorflow_hub</span> <span class="k">as</span> <span class="n">hub</span>

<span class="n">hub_layer</span> <span class="o">=</span> <span class="n">hub</span><span class="o">.</span><span class="n">KerasLayer</span><span class="p">(</span><span class="s">"https://tfhub.dev/google/tf2-preview/nnlm-en-dim50/1"</span><span class="p">,</span>
                           <span class="n">output_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">],</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">[],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hub_layer</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'sigmoid'</span><span class="p">))</span>

<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">
        <div class="language-plaintext output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Model: "sequential_3"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
keras_layer (KerasLayer)     (None, 50)                48190600  
_________________________________________________________________
dense_4 (Dense)              (None, 16)                816       
_________________________________________________________________
dense_5 (Dense)              (None, 1)                 17        
=================================================================
Total params: 48,191,433
Trainable params: 833
Non-trainable params: 48,190,600
_________________________________________________________________
</code></pre></div>        </div>
      </div>
    </div>
  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sentences</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="s">"It was a great movie"</span><span class="p">,</span> <span class="s">"The actors were amazing"</span><span class="p">])</span>
<span class="n">embeddings</span> <span class="o">=</span> <span class="n">hub_layer</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span>

</code></pre></div>      </div>
    </div>

  </div>

  <div class="cell code_cell">
    <div class="input_area">
      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">embeddings</span>

</code></pre></div>      </div>
    </div>

    <div class="output_wrapper">
      <div class="output_subarea">

        <div class="language-plaintext output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;tf.Tensor: id=665258, shape=(2, 50), dtype=float32, numpy=
array([[ 7.45939985e-02,  2.76720114e-02,  9.38646123e-02,
         1.25124469e-01,  5.40293928e-04, -1.09435350e-01,
         1.34755149e-01, -9.57818255e-02, -1.85177118e-01,
        -1.69703495e-02,  1.75612606e-02, -9.06603858e-02,
         1.12110220e-01,  1.04646273e-01,  3.87700424e-02,
        -7.71859884e-02, -3.12189370e-01,  6.99466765e-02,
        -4.88970093e-02, -2.99049795e-01,  1.31183028e-01,
        -2.12630898e-01,  6.96169436e-02,  1.63592950e-01,
         1.05169769e-02,  7.79720694e-02, -2.55230188e-01,
        -1.80790052e-01,  2.93739915e-01,  1.62875261e-02,
        -2.80566931e-01,  1.60284728e-01,  9.87277832e-03,
         8.44555616e-04,  8.39456245e-02,  3.24002892e-01,
         1.53253034e-01, -3.01048346e-02,  8.94618109e-02,
        -2.39153411e-02, -1.50188789e-01, -1.81733668e-02,
        -1.20483577e-01,  1.32937476e-01, -3.35325629e-01,
        -1.46504581e-01, -1.25251599e-02, -1.64428815e-01,
        -7.00765476e-02,  3.60923223e-02],
       [-1.56998575e-01,  4.24599349e-02, -5.57703003e-02,
        -8.08446854e-03,  1.23733155e-01,  3.89427543e-02,
        -4.37901802e-02, -1.86987907e-01, -2.29341656e-01,
        -1.27766818e-01,  3.83025259e-02, -1.07057482e-01,
        -6.11584112e-02,  2.49654502e-01, -1.39712945e-01,
        -3.91289443e-02, -1.35873526e-01, -3.58613044e-01,
         2.53462754e-02, -1.58370987e-01, -1.38350084e-01,
        -3.90771806e-01, -6.63642734e-02, -3.24838236e-02,
        -2.20453963e-02, -1.68282315e-01, -7.40613639e-02,
        -2.49074101e-02,  2.46460736e-01,  9.87201929e-05,
        -1.85390845e-01, -4.92824614e-02,  1.09015472e-01,
        -9.54203904e-02, -1.60352528e-01, -2.59811729e-02,
         1.13778859e-01, -2.09578887e-01,  2.18261331e-01,
        -3.11211571e-02, -6.12562597e-02, -8.66057724e-02,
        -1.10762455e-01, -5.73977083e-03, -1.08923554e-01,
        -1.72919363e-01,  1.00515485e-01, -5.64153939e-02,
        -4.97694984e-02, -1.07776590e-01]], dtype=float32)&gt;
</code></pre></div>        </div>

      </div>
    </div>
  </div>

</div>

              <nav class="c-page__nav">
  
    
    <a id="js-page__nav__prev" class="c-page__nav__prev" href="/notebooks/24-tensorflow/11_training_deep_neural_networks.html">
      〈 <span class="u-margin-right-tiny"></span> TF-training
    </a>
  

  
    
    <a id="js-page__nav__next" class="c-page__nav__next" href="/notebooks/24-tensorflow/14_deep_computer_vision_with_cnns.html">
      TF-CNN <span class="u-margin-right-tiny"></span> 〉
    </a>
  
</nav>

            </div>
          </div>
        </div>
      </main>
    </div>

  </body>
</html>
